description: |-
  Стандартные тесты MSRPC

  Заготовка на будущее:

  for i in getusername dsroledominfo dfsversion srvinfo enumdomusers enummonitors dsr_enumtrustdom fss_get_sup_version clusapi_get_cluster_version dsgetdcinfo echodata epmmap eventlog_readlog winspool_AsyncCorePrinterDriverInstalled ntsvcs_getversion fetch_properties winreg_enumkey GetInterfaceList wkssvc_wkstagetinfo; do rpcclient -p 135 -I 8.8.8.8 ncacn_ip_tcp:8.8.18.8[49155] -c $i; done
author: hacktricks
tags:
  - 135
  - 593
  - msrpc
install: |-
  # нужен rpcclient, impacket
  # Нужно скачать IOXIDResolver и закинуть в path:
  git clone https://github.com/mubix/IOXIDResolver
  cd IOXIDResolver
  sudo ln -s $(realpath ./IOXIDResolver.py) /usr/local/bin/IOXIDResolver
arguments:
  targs:
    default:
    replacer: __TARGS__
    description: >-
      Цели для тестирования (пример: '127.0.0.1:135 127.0.0.2:593')
shell: /bin/bash
script:
item_1:
  description: Тесты nmap
  script: >-
    sudo nmap -sS -Pn -sV --script=msrpc-enum --open -p$(for i in __TARGS__; do echo $i | cut -f2 -d:; done | sort -u | paste -sd",") $(for i in __TARGS__; do echo $i | cut -f1 -d:; done | sort -u | paste -sd" ")
item_2:
  description: Тест анонимного подключения
  script: >-
    for i in __TARGS__; do echo "+++ Connection to $i:"; rpcclient -N -U "" $(echo $i | cut -f1 -d:) -p $(echo $i | cut -f2 -d:) -c getusername; echo; done
item_3:
  description: Получение инфы о сетевом интерфейсе
  script: >-
    for i in $(echo '__TARGS__' | tr ' ' '\n' | awk '{split($0,a,":"); print a[1]}' | uniq); do IOXIDResolver -t $i; echo; done
item_4:
  description: Дамп RPC endpoints с помощью impacket-rpcdump
  script: >-
    for i in $(echo '__TARGS__' | tr ' ' '\n' | grep -e ":135" -e ":593" | uniq); do echo "+++ Connection to $i:"; impacket-rpcdump $(echo $i | cut -f1 -d:) -port $(echo $i | cut -f2 -d:); echo; done
item_5:
  description: Дампит список ncacn_tcp RPC-сервисов (только порт 135!)
  script: >-
    msfprms="use auxiliary/scanner/dcerpc/hidden;"; for i in $(echo '__TARGS__' | tr ' ' '\n' | awk '{split($0,a,":"); print a[1]}' | uniq); do msfprms+="set rhosts $i; run; "; done; msfprms+="quit"; msfconsole -q -x "$msfprms"